<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Delivery Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: Arial, sans-serif;
    }

    header {
      background: #00A651;
      color: white;
      padding: 10px;
      text-align: center;
      position: fixed;
      width: 100%;
      z-index: 1000;
    }

    header h1 {
      margin: 0;
      font-size: 20px;
    }

    .search-container {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .search-container input, button {
      margin: 5px;
      padding: 8px;
      font-size: 14px;
      width: 90%;
      max-width: 300px;
      border-radius: 5px;
      border: none;
    }

    #map {
      position: absolute;
      top: 140px;
      bottom: 0;
      width: 100%;
    }

    .autocomplete-suggestions {
      background: white;
      color: black; /* ✅ visible text */
      border: 1px solid #ccc;
      position: absolute;
      max-height: 150px;
      overflow-y: auto;
      width: 90%;
      max-width: 300px;
      top: 130px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1001;
      border-radius: 5px;
    }

    .autocomplete-suggestions div {
      padding: 8px;
      cursor: pointer;
    }

    .autocomplete-suggestions div:hover {
      background: #f0f0f0;
    }

    .leaflet-bottom.leaflet-right {
      margin-bottom: 60px !important;
    }
  </style>
</head>
<body>
  <header>
    <h1>Delivery Map</h1>
    <div class="search-container">
      <input id="shopSearch" placeholder="🔍 Search shop name" autocomplete="off" />
      <div id="autocomplete" class="autocomplete-suggestions"></div>
      <button onclick="resetFilters()">Reset Filters</button>
    </div>
  </header>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const map = L.map('map', { zoomControl: false }).setView([22.5726, 88.3639], 10);
    L.control.zoom({ position: 'bottomright' }).addTo(map);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const shopInput = document.getElementById("shopSearch");
    const autocomplete = document.getElementById("autocomplete");

    let allMarkers = [];
    let markerMap = {};
    let selectedNames = [];

    const normalIcon = L.icon({
      iconUrl: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
      iconSize: [32, 32],
      iconAnchor: [16, 32],
      popupAnchor: [0, -32]
    });

    const smallIcon = L.icon({
      iconUrl: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
      iconSize: [10, 10],
      iconAnchor: [5, 10],
      popupAnchor: [0, -10]
    });

    function showShops(data) {
      const shopDisplayList = [];

      data.forEach(row => {
        const lat = parseFloat(row["Latitude"]);
        const lng = parseFloat(row["Longitude"]);
        if (!lat || !lng) return;

        const shopName = (row["Shop Name"] || "").trim();
        const shopCode = (row["Shop Code"] || "").trim();
        const display = `${shopName} (${shopCode})`;

        const marker = L.marker([lat, lng], { icon: smallIcon }).bindPopup(`
          <b>${shopName}</b><br>
          Code: ${shopCode}<br>
          Sales: ${row["Sales Person"]}<br>
          Route: ${row["Route ID"]}<br>
          Phone: <a href="tel:${row["Mobile 1"]}">${row["Mobile 1"]}</a><br>
          <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}" target="_blank">🧭 Navigate on Map</a>
        `);
        marker.key = shopName.toLowerCase();  // Just the name
        allMarkers.push(marker);
        markerMap[marker.key] = marker;
        marker.addTo(map);

        shopDisplayList.push(display); // For suggestions
      });

      // Autocomplete logic
      shopInput.addEventListener("input", () => {
        const term = shopInput.value.trim().toLowerCase().split(',').pop().trim();
        autocomplete.innerHTML = "";
        if (!term) return;

        const matched = shopDisplayList.filter(entry => entry.toLowerCase().includes(term));
        matched.forEach(fullDisplay => {
          const div = document.createElement("div");
          div.textContent = fullDisplay;
          div.onclick = () => {
            const shopNameOnly = fullDisplay.split('(')[0].trim().toLowerCase();
            addShopToSelection(shopNameOnly, fullDisplay);
          };
          autocomplete.appendChild(div);
        });
      });
    }

    function addShopToSelection(shopKey, displayValue) {
      if (!selectedNames.includes(shopKey)) {
        selectedNames.push(shopKey);
      }

      // Show only names (no codes) in input
      shopInput.value = selectedNames.map(n => capitalize(n)).join(", ") + ", ";
      autocomplete.innerHTML = "";

      // Update markers
      allMarkers.forEach(marker => {
        map.removeLayer(marker);
        marker.setIcon(smallIcon);
      });

      const visible = selectedNames.map(k => markerMap[k]).filter(Boolean);
      visible.forEach(marker => {
        marker.setIcon(normalIcon);
        marker.addTo(map);
      });

      if (visible.length > 0) {
        const bounds = L.latLngBounds(visible.map(m => m.getLatLng()));
        map.fitBounds(bounds, { padding: [30, 30] });
      }
    }

    function resetFilters() {
      selectedNames = [];
      shopInput.value = "";
      autocomplete.innerHTML = "";

      allMarkers.forEach(marker => {
        marker.setIcon(smallIcon);
        marker.addTo(map);
      });
// Close any popup
  map.closePopup();
  
      const bounds = L.latLngBounds(allMarkers.map(m => m.getLatLng()));
      map.fitBounds(bounds, { padding: [30, 30] });
    }

    function capitalize(text) {
      return text.replace(/\b\w/g, c => c.toUpperCase());
    }

    const publicCSV = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQeQNGO8MaX3SJmuO3vS5GsxzOvFysgW6N-wKGNZyo970vw4bBIYJkUyb3Emgy0WMGnhzGx7Dr2DunX/pub?gid=0&single=true&output=csv';
    Papa.parse(publicCSV, {
      download: true,
      header: true,
      complete: function(results) {
        showShops(results.data);
      }
    });
  </script>
</body>
</html>
